{% extends "base.html" %}

{% block title %}Data Explorer - Mexican Trout Biodiversity Project{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-database me-3"></i>Data Explorer</h1>
            <p class="lead">Browse, filter, and analyze Mexican trout occurrence data</p>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter me-2"></i>Advanced Filters</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="species-filter" class="form-label">Species:</label>
                            <select class="form-select" id="species-filter">
                                <option value="">All Species</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="basin-filter" class="form-label">River Basin:</label>
                            <select class="form-select" id="basin-filter">
                                <option value="">All Basins</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="state-filter" class="form-label">State:</label>
                            <select class="form-select" id="state-filter">
                                <option value="">All States</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="year-range" class="form-label">Year Range:</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="year-start" placeholder="Start" min="1900" max="2025">
                                <span class="input-group-text">to</span>
                                <input type="number" class="form-control" id="year-end" placeholder="End" min="1900" max="2025">
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="collector-filter" class="form-label">Collector:</label>
                            <input type="text" class="form-control" id="collector-filter" placeholder="Search collectors...">
                        </div>
                        <div class="col-md-3">
                            <label for="institution-filter" class="form-label">Institution:</label>
                            <select class="form-select" id="institution-filter">
                                <option value="">All Institutions</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="coordinate-filter" class="form-label">Has Coordinates:</label>
                            <select class="form-select" id="coordinate-filter">
                                <option value="">All Records</option>
                                <option value="yes">With Coordinates</option>
                                <option value="no">Without Coordinates</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button class="btn btn-primary" id="apply-filters">
                                    <i class="fas fa-search me-2"></i>Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-secondary me-2" id="clear-filters">
                                <i class="fas fa-times me-2"></i>Clear All Filters
                            </button>
                            <button class="btn btn-success me-2" id="export-csv">
                                <i class="fas fa-download me-2"></i>Export CSV
                            </button>
                            <button class="btn btn-info me-2" id="export-json">
                                <i class="fas fa-code me-2"></i>Export JSON
                            </button>
                            <button class="btn btn-warning" id="show-statistics">
                                <i class="fas fa-chart-bar me-2"></i>View Statistics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Summary -->
    <div class="row mb-4" id="statistics-panel" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Data Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="total-records">-</h3>
                                <p class="text-muted">Total Records</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="records-with-coords">-</h3>
                                <p class="text-muted">With Coordinates</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="unique-species">-</h3>
                                <p class="text-muted">Unique Species</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 id="date-range">-</h3>
                                <p class="text-muted">Date Range</p>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <canvas id="species-chart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <canvas id="basin-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-table me-2"></i>Occurrence Records</h5>
                    <div>
                        <span class="badge bg-primary" id="record-count">0 records</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Species</th>
                                    <th>Date</th>
                                    <th>Latitude</th>
                                    <th>Longitude</th>
                                    <th>Locality</th>
                                    <th>State</th>
                                    <th>Basin</th>
                                    <th>Collectors</th>
                                    <th>Institution</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Data pagination">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Record Detail Modal -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="recordModalBody">
                <!-- Record details will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="viewOnMap">View on Map</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentData = [];
let filteredData = [];
let currentPage = 1;
let recordsPerPage = 25;
let totalRecords = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadFilterOptions();
    loadData();
    
    // Event listeners
    document.getElementById('apply-filters').addEventListener('click', applyFilters);
    document.getElementById('clear-filters').addEventListener('click', clearFilters);
    document.getElementById('export-csv').addEventListener('click', exportCSV);
    document.getElementById('export-json').addEventListener('click', exportJSON);
    document.getElementById('show-statistics').addEventListener('click', toggleStatistics);
});

// Load filter options
function loadFilterOptions() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            // Populate species filter
            const speciesFilter = document.getElementById('species-filter');
            data.species.forEach(species => {
                const option = document.createElement('option');
                option.value = species;
                option.textContent = species;
                speciesFilter.appendChild(option);
            });
            
            // Populate basin filter
            const basinFilter = document.getElementById('basin-filter');
            data.basins.forEach(basin => {
                const option = document.createElement('option');
                option.value = basin;
                option.textContent = basin;
                basinFilter.appendChild(option);
            });
            
            // Populate state filter
            const stateFilter = document.getElementById('state-filter');
            data.states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateFilter.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading filter options:', error);
        });
}

// Load data
function loadData(page = 1) {
    const params = new URLSearchParams({
        page: page,
        per_page: recordsPerPage
    });
    
    // Add filters to params
    const species = document.getElementById('species-filter').value;
    const basin = document.getElementById('basin-filter').value;
    const state = document.getElementById('state-filter').value;
    const collector = document.getElementById('collector-filter').value;
    const institution = document.getElementById('institution-filter').value;
    const coordinates = document.getElementById('coordinate-filter').value;
    const yearStart = document.getElementById('year-start').value;
    const yearEnd = document.getElementById('year-end').value;
    
    if (species) params.append('species', species);
    if (basin) params.append('basin', basin);
    if (state) params.append('state', state);
    if (collector) params.append('collector', collector);
    if (institution) params.append('institution', institution);
    if (coordinates) params.append('coordinates', coordinates);
    if (yearStart) params.append('year_start', yearStart);
    if (yearEnd) params.append('year_end', yearEnd);
    
    fetch(`/api/occurrences?${params}`)
        .then(response => response.json())
        .then(data => {
            currentData = data.records;
            totalRecords = data.pagination.total;
            currentPage = data.pagination.page;
            
            displayTable();
            updatePagination();
            updateRecordCount();
        })
        .catch(error => {
            console.error('Error loading data:', error);
        });
}

// Display table
function displayTable() {
    const tbody = document.querySelector('#data-table tbody');
    tbody.innerHTML = '';
    
    currentData.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.unique_record_id}</td>
            <td>${record.species || 'Unknown'}</td>
            <td>${record.collection_date || 'Unknown'}</td>
            <td>${record.latitude || 'N/A'}</td>
            <td>${record.longitude || 'N/A'}</td>
            <td>${record.locality_description || 'Unknown'}</td>
            <td>${record.state || 'Unknown'}</td>
            <td>${record.river_basin || 'Unknown'}</td>
            <td>${record.collectors || 'Unknown'}</td>
            <td>${record.institution || 'Unknown'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="showRecordDetails(${record.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-success" onclick="viewOnMap(${record.longitude}, ${record.latitude})">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update pagination
function updatePagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    const totalPages = Math.ceil(totalRecords / recordsPerPage);
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

// Change page
function changePage(page) {
    if (page < 1) return;
    loadData(page);
}

// Update record count
function updateRecordCount() {
    document.getElementById('record-count').textContent = `${totalRecords} records`;
}

// Apply filters
function applyFilters() {
    loadData(1);
}

// Clear filters
function clearFilters() {
    document.getElementById('species-filter').value = '';
    document.getElementById('basin-filter').value = '';
    document.getElementById('state-filter').value = '';
    document.getElementById('collector-filter').value = '';
    document.getElementById('institution-filter').value = '';
    document.getElementById('coordinate-filter').value = '';
    document.getElementById('year-start').value = '';
    document.getElementById('year-end').value = '';
    
    loadData(1);
}

// Export CSV
function exportCSV() {
    const params = new URLSearchParams();
    
    // Add current filters to export
    const species = document.getElementById('species-filter').value;
    const basin = document.getElementById('basin-filter').value;
    const state = document.getElementById('state-filter').value;
    
    if (species) params.append('species', species);
    if (basin) params.append('basin', basin);
    if (state) params.append('state', state);
    
    window.location.href = `/api/export-data?${params}`;
}

// Export JSON
function exportJSON() {
    const params = new URLSearchParams({
        per_page: 10000  // Get all records
    });
    
    // Add current filters
    const species = document.getElementById('species-filter').value;
    const basin = document.getElementById('basin-filter').value;
    const state = document.getElementById('state-filter').value;
    
    if (species) params.append('species', species);
    if (basin) params.append('basin', basin);
    if (state) params.append('state', state);
    
    fetch(`/api/occurrences?${params}`)
        .then(response => response.json())
        .then(data => {
            const jsonStr = JSON.stringify(data.records, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'mexican_trout_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error exporting JSON:', error);
        });
}

// Toggle statistics
function toggleStatistics() {
    const panel = document.getElementById('statistics-panel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        loadStatistics();
    } else {
        panel.style.display = 'none';
    }
}

// Load statistics
function loadStatistics() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-records').textContent = data.total_records;
            document.getElementById('records-with-coords').textContent = data.records_with_coordinates;
            document.getElementById('unique-species').textContent = data.species.length;
            
            // Create charts
            createSpeciesChart(data.species);
            createBasinChart(data.basins);
        })
        .catch(error => {
            console.error('Error loading statistics:', error);
        });
}

// Create species chart
function createSpeciesChart(species) {
    const ctx = document.getElementById('species-chart').getContext('2d');
    
    // Get species counts (this would need to be implemented in the API)
    const speciesData = species.map(s => ({ name: s, count: Math.floor(Math.random() * 50) + 1 }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: speciesData.map(s => s.name),
            datasets: [{
                label: 'Records per Species',
                data: speciesData.map(s => s.count),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Create basin chart
function createBasinChart(basins) {
    const ctx = document.getElementById('basin-chart').getContext('2d');
    
    // Get basin counts (this would need to be implemented in the API)
    const basinData = basins.map(b => ({ name: b, count: Math.floor(Math.random() * 30) + 1 }));
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: basinData.map(b => b.name),
            datasets: [{
                data: basinData.map(b => b.count),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Show record details
function showRecordDetails(recordId) {
    const record = currentData.find(r => r.id === recordId);
    if (!record) return;
    
    const modalBody = document.getElementById('recordModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <p><strong>Record ID:</strong> ${record.unique_record_id}</p>
                <p><strong>Species:</strong> ${record.species || 'Unknown'}</p>
                <p><strong>Collection Date:</strong> ${record.collection_date || 'Unknown'}</p>
                <p><strong>Collectors:</strong> ${record.collectors || 'Unknown'}</p>
                <p><strong>Field Number:</strong> ${record.field_number || 'Unknown'}</p>
            </div>
            <div class="col-md-6">
                <h6>Location</h6>
                <p><strong>Latitude:</strong> ${record.latitude || 'Unknown'}</p>
                <p><strong>Longitude:</strong> ${record.longitude || 'Unknown'}</p>
                <p><strong>Locality:</strong> ${record.locality_description || 'Unknown'}</p>
                <p><strong>State:</strong> ${record.state || 'Unknown'}</p>
                <p><strong>Municipality:</strong> ${record.municipality || 'Unknown'}</p>
                <p><strong>River Basin:</strong> ${record.river_basin || 'Unknown'}</p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Specimen Information</h6>
                <p><strong>Institution:</strong> ${record.institution || 'Unknown'}</p>
                <p><strong>Catalog Number:</strong> ${record.catalog_number || 'Unknown'}</p>
                <p><strong>Specimen Count:</strong> ${record.specimen_count || 'Unknown'}</p>
            </div>
            <div class="col-md-6">
                <h6>Conservation</h6>
                <p><strong>Conservation Status:</strong> ${record.conservation_status || 'Unknown'}</p>
                <p><strong>Data Source:</strong> ${record.data_source || 'Unknown'}</p>
            </div>
        </div>
    `;
    
    // Store coordinates for map view
    document.getElementById('viewOnMap').onclick = () => viewOnMap(record.longitude, record.latitude);
    
    const modal = new bootstrap.Modal(document.getElementById('recordModal'));
    modal.show();
}

// View on map
function viewOnMap(lng, lat) {
    if (lng && lat) {
        window.location.href = `/map?lat=${lat}&lng=${lng}&zoom=12`;
    } else {
        alert('No coordinates available for this record');
    }
}
</script>
{% endblock %} 